#!/bin/bash

# Script: combined_query_weekly.sh
# Purpose: Run OIM Medium-Term (7-day window) weekly or recovery for a specific date
# Usage:
#   Default run: ./combined_query_weekly.sh
#   Recovery run: ./combined_query_weekly.sh "YYYY-MM-DD"

# --------------------------------------------------------------------
# Configuration
# --------------------------------------------------------------------
PYTHON_SCRIPT="/home/cadmin/Scripts/Analytics_Scripts/OIM_Short_Mid/combined_query_weekly.py"
LOG_FILE="/home/cadmin/Scripts/Analytics_Scripts/OIM_Short_Mid/Medium_Term.log"
SPARK_SUBMIT_ARGS="--num-executors 8 \
  --executor-memory 12g \
  --executor-cores 4 \
  --driver-memory 8g \
  --conf spark.executor.memoryOverhead=3072 \
  --conf spark.sql.shuffle.partitions=150 \
  --conf spark.dynamicAllocation.enabled=false \
  --queue root.users.cadmin"

# --------------------------------------------------------------------
# Function to log messages
# --------------------------------------------------------------------
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# --------------------------------
------------------------------------
# Rotate logs before each run
# --------------------------------------------------------------------
mv "$LOG_FILE" "${LOG_FILE}.$(date +'%Y%m%d%H%M%S')" 2>/dev/null

# --------------------------------------------------------------------
# Determine run type
# --------------------------------------------------------------------
if [ $# -eq 0 ]; then
    log_message "üöÄ Starting default weekly medium-term run"
elif [ $# -eq 1 ]; then
    recovery_date="$1"
    if ! date -d "$recovery_date" >/dev/null 2>&1; then
        log_message "‚ùå ERROR: Invalid date format: $recovery_date"
        exit 1
    fi
    log_message "üîÅ Starting recovery medium-term run for date: $recovery_date"
else
    log_message "‚ùå ERROR: Invalid number of arguments. Usage: $0 [YYYY-MM-DD]"
    exit 1
fi

# --------------------------------------------------------------------
# Prepare arguments
# --------------------------------------------------------------------
spark_args=()
if [ $# -eq 1 ]; then
    spark_args=("$recovery_date")
fi

# --------------------------------------------------------------------
# Execute Spark job
# --------------------------------------------------------------------
log_message "üí° Running Spark job..."
spark-submit $SPARK_SUBMIT_ARGS "$PYTHON_SCRIPT" "${spark_args[@]}" >> "$LOG_FILE" 2>&1

# --------------------------------------------------------------------
# Verify job status
# --------------------------------------------------------------------
if [ $? -eq 0 ]; then
    log_message "‚úÖ Medium-term OIM job completed successfully."
else
    log_message "‚ùå ERROR: Medium-term OIM job failed. Check logs for details."
    exit 1
fi
