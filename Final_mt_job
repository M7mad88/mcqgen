#!/bin/bash
###############################################################################
# OIM Medium-Term Spark Job
# Runs weekly (7-day window) or in recovery mode if a date is provided
# Usage:
#   ./oim_medium_term_job.sh                → Default (for current day)
#   ./oim_medium_term_job.sh 2025-10-19     → Recovery mode (specific date)
###############################################################################

# ----------------------------
# Configuration
# ----------------------------
PY_SCRIPT="/home/cadmin/Scripts/Analytics_Scripts/oim_medium_term/combined_query_weekly.py"
LOG_DIR="/home/cadmin/Scripts/Analytics_Scripts/oim_medium_term/logs"
mkdir -p "$LOG_DIR"

CURRENT_DATE=$(date +"%Y-%m-%d")
LOG_FILE="$LOG_DIR/oim_medium_term_${CURRENT_DATE}.log"

echo "---------------------------------------------------------------"
echo "OIM Medium-Term Job Started at $(date)"
echo "---------------------------------------------------------------"

# ----------------------------
# Spark Job Execution
# ----------------------------
if [ $# -eq 0 ]; then
    echo "$(date '+%Y-%m-%d %H:%M:%S') - Starting default weekly medium-term run" | tee -a "$LOG_FILE"
    spark-submit \
        --master yarn \
        --deploy-mode client \
        --driver-memory 8G \
        --executor-memory 8G \
        --num-executors 15 \
        --executor-cores 4 \
        "$PY_SCRIPT" >> "$LOG_FILE" 2>&1
else
    echo "$(date '+%Y-%m-%d %H:%M:%S') - Starting RECOVERY medium-term run for date: $1" | tee -a "$LOG_FILE"
    spark-submit \
        --master yarn \
        --deploy-mode client \
        --driver-memory 8G \
        --executor-memory 8G \
        --num-executors 15 \
        --executor-cores 4 \
        "$PY_SCRIPT" "$1" >> "$LOG_FILE" 2>&1
fi

STATUS=$?
if [ $STATUS -eq 0 ]; then
    echo "$(date '+%Y-%m-%d %H:%M:%S') - Medium-term OIM job completed successfully" | tee -a "$LOG_FILE"
else
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ERROR: Medium-term OIM job failed. Check logs: $LOG_FILE" | tee -a "$LOG_FILE"
fi

echo "---------------------------------------------------------------"
echo "OIM Medium-Term Job Finished at $(date)"
echo "---------------------------------------------------------------"
