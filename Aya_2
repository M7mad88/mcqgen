CREATE MULTISET TABLE twm_result.DSL_FullUtil_NoAddon_After_MHR AS
(
    SEL
        /* ====== stratification columns ====== */
        bs.Subscription_Id                                
       ,bs.Rate_Plan_Group                                
       ,bs.Tenure_Days                                   
       ,bs.DSL_Over_Fixed_Flag                          
       ,bs.Digital_User_Flag                              
       ,bs.Total_MBs_2M                                   

       /* Usage band (2 months) */
       ,CASE
            WHEN bs.Total_MBs_2M < 50   THEN 'USG_0_50'
            WHEN bs.Total_MBs_2M < 100  THEN 'USG_50_100'
            WHEN bs.Total_MBs_2M < 200  THEN 'USG_100_200'
            WHEN bs.Total_MBs_2M < 500  THEN 'USG_200_500'
            ELSE 'USG_500_PLUS'
        END                                              AS Usage_Band           

       /* Tenure band (days) */
       ,CASE
            WHEN bs.Tenure_Days < 180  THEN 'TEN_SHORT'
            WHEN bs.Tenure_Days < 365  THEN 'TEN_MED'
            ELSE 'TEN_LONG'
        END                                              AS Tenure_Band         

       /* ====== Revenue windows (M3 / M2 / M1) ====== */
       ,Sum(CASE
              WHEN asrd.Revenue_Date BETWEEN DATE - 90 AND DATE - 61
                   THEN asrd.Total_Revenue ELSE 0
            END)                                         AS M3_Total_Rev         

       ,Sum(CASE
              WHEN asrd.Revenue_Date BETWEEN DATE - 60 AND DATE - 31
                   THEN asrd.Total_Revenue ELSE 0
            END)                                         AS M2_Total_Rev         

       ,Sum(CASE
              WHEN asrd.Revenue_Date BETWEEN DATE - 30 AND DATE - 1
                   THEN asrd.Total_Revenue ELSE 0
            END)                                         AS M1_Total_Rev         
       /* ====== Exclusion logic (AB / Master CG) ====== */
       ,CASE
            WHEN AB.Subscription_Id IS NULL
             AND (MCG.UCG_Flag = 0 OR MCG.Subscription_Id IS NULL)
            THEN 1
            ELSE 0
        END                                              AS should_be_selected   -- 12

    FROM twm_result.DSL_FullUtil_NoAddon_Before_MHR bs

    /* existing AB tests */
    LEFT JOIN VDB.AB_Testing_CG_TG AB
        ON AB.Subscription_Id = bs.Subscription_Id

    /* master control group */
    LEFT JOIN VDB.Master_Control_Group MCG
        ON MCG.Subscription_Id = bs.Subscription_Id

    /* revenue */
    LEFT JOIN VDB.Agg_Subs_Revenue_Daily asrd
        ON asrd.Subscription_Id = bs.Subscription_Id
       AND asrd.Revenue_Date BETWEEN DATE - 90 AND DATE - 1

    
    GROUP BY 1,2,3,4,5,6,7,8,12
)
WITH DATA PRIMARY INDEX (Subscription_Id);
